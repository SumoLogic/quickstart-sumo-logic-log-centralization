AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "This CloudFormation template sets up AWS and Sumo Logic resources for all of the Sumo Logic security apps. (qs-1qqlknohm)"

Metadata:
  QuickStartDocumentation:
    EntrypointName: "Parameters for deploying Sumo Logic"
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "1.1 Sumo Logic access configuration (required)"
        Parameters:
          - Section1aSumoLogicDeployment
          - Section1bSumoLogicAccessID
          - Section1cSumoLogicAccessKey
          - Section1dSumoLogicOrganizationId
          - Section1eSumoLogicResourceRemoveOnDeleteStack

      - Label:
          default: "2.1 CloudTrail app configuration"
        Parameters:
          - Section2InstallCloudTrailApp
          - Section2InstallPCICloudTrailApp
          - Section2InstallCISFoundationApp
          - Section2InstallCloudTrailMonitoringAnalyticsApp
          - Section2InstallCloudTrailSecOpsApp
      - Label:
          default: "2.2 S3 configuration"
        Parameters:
          - Section2CloudTrailCreateBucket
          - Section2CloudTrailLogsBucketName
      - Label:
          default: "2.3 CloudTrail source configuration"
        Parameters:
          - Section2CloudTrailCreateLogSource
          - Section2CloudTrailBucketPathExpression
          - Section2CloudTrailLogsSourceCategoryName

      - Label:
          default: "3.1 GuardDuty app configuration"
        Parameters:
          - Section3aInstallGuardDutyApps
      - Label:
          default: "3.2 GuardDuty log-source configuration"
        Parameters:
          - Section3bGuardDutyCreateHttpLogsSource
          - Section3cGuardDutyHttpLogsSourceCategoryName

      - Label:
          default: "4.1 VPC flow logs app configuration"
        Parameters:
          - Section4aInstallVpcApps
      - Label:
          default: "4.2 S3 configuration"
        Parameters:
          - Section4bVpcCreateBucket
          - Section4cVpcLogsBucketName
      - Label:
          default: "4.3 VPC S3 source configuration"
        Parameters:
          - Section4dVpcCreateS3Source
          - Section4eVpcBucketPathExpression
          - Section4fVpcLogsSourceCategoryName

      - Label:
          default: "5.1 Sumo Logic Threat Intel for AWS Config"
        Parameters:
          - Section5aInstallThreatIntelApp
          - Section5bElasticLoadBalancerSourceCategory

      - Label:
          default: "6.1 Sumo Logic S3 audit app configuration"
        Parameters:
          - Section6aInstallS3AuditApp
      - Label:
          default: "6.2 S3 configuration"
        Parameters:
          - Section6bS3AuditCreateBucket
          - Section6cS3AuditLogsBucketName
      - Label:
          default: "6.3 VPC S3 source configuration"
        Parameters:
          - Section6dS3AuditCreateS3Source
          - Section6eS3AuditBucketPathExpression
          - Section6fS3AuditLogsSourceCategoryName

      - Label:
          default: "7.1 AWS Security Hub app configuration"
        Parameters:
          - Section7aInstallSecurityHubAuditApp
          - Section7bEnableSecurityHub
      - Label:
          default: "7.2 S3 configuration"
        Parameters:
          - Section7cSecurityHubCreateBucket
          - Section7dSecurityHubLogsBucketName
      - Label:
          default: "7.3 Sumo Logic Security Hub S3 source configuration"
        Parameters:
          - Section7eSecurityHubCreateS3Source
          - Section7fSecurityHubBucketPathExpression
          - Section7gSecurityHubLogsSourceCategoryName

      - Label:
          default: "8.1 Sumo Logic AWS WAF app configuration"
        Parameters:
          - Section8aInstallWafApp
          - Section8bCreateDeliveryStream
      - Label:
          default: "8.2 S3 configuration"
        Parameters:
          - Section8cWafCreateBucket
          - Section8dWafLogsBucketName
      - Label:
          default: "8.3 Sumo Logic AWS WAF S3 source configuration"
        Parameters:
          - Section8eWafCreateS3Source
          - Section8fWafBucketPathExpression
          - Section8gWafLogsSourceCategoryName

      - Label:
          default: "9.1 Sumo Logic AWS Config app configuration"
        Parameters:
          - Section9aInstallConfigApp
      - Label:
          default: "9.2 AWS Config Configuration"
        Parameters:
          - Section9bConfigEnableConfig
          - Section9cConfigCreateSNSTopic
          - Section9dConfigExistingTopicName
      - Label:
          default: "9.3 Sumo Logic AWS Config HTTP logs source configuration"
        Parameters:
          - Section9eConfigCreateHttpLogsSource
          - Section9fConfigHttpLogsSourceCategoryName

      - Label:
          default: "10.1 Auto-enable logging configuration"
        Parameters:
          - Section91aEnableAutoLogging
          - Section91bEnableLoggingForExistingResources
      - Label:
          default: "10.2 S3 audit logging of auto-enable configuration"
        Parameters:
          - Section91cS3LoggingBucketPrefix
          - Section91dS3LoggingFilterExpression
      - Label:
          default: "10.3 VPC flow logs auto-enable configuration"
        Parameters:
          - Section91eVPCLoggingBucketPrefix
          - Section91fVPCLoggingFilterExpression

      - Label:
          default: "AWS Quick Start configuration"
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix

    ParameterLabels:
      Section1aSumoLogicDeployment:
        default: "Sumo Logic deployment name"
      Section1bSumoLogicAccessID:
        default: "Sumo Logic access ID"
      Section1cSumoLogicAccessKey:
        default: "Sumo Logic access key"
      Section1dSumoLogicOrganizationId:
        default: "Sumo Logic organization ID"
      Section1eSumoLogicResourceRemoveOnDeleteStack:
        default: "Delete Sumo Logic resources when stack is deleted"

      # CloudTrail apps parameters
      Section2InstallCloudTrailApp:
        default: "Install Sumo Logic AWS CloudTrail app"
      Section2InstallPCICloudTrailApp:
        default: "Install Sumo Logic PCI compliance for AWS CloudTrail app"
      Section2InstallCISFoundationApp:
        default: "Install Sumo Logic CIS AWS Foundations Benchmark app"
      Section2InstallCloudTrailMonitoringAnalyticsApp:
        default: "Install Amazon CloudTrail - Sumo Cloud Security Monitoring and Analytics App"
      Section2InstallCloudTrailSecOpsApp:
        default: "Install Sumo Global Intelligence for AWS CloudTrail SecOps App"
      Section2CloudTrailCreateBucket:
        default: "Create S3 bucket"
      Section2CloudTrailLogsBucketName:
        default: "S3 bucket name"
      Section2CloudTrailCreateLogSource:
        default: "Create Sumo Logic CloudTrail logs source"
      Section2CloudTrailBucketPathExpression:
        default: "Path expression for logs"
      Section2CloudTrailLogsSourceCategoryName:
        default: "Sumo Logic CloudTrail logs source category name"

      # GuardDuty apps parameters
      Section3aInstallGuardDutyApps:
        default: "Install Sumo Logic GuardDuty app"
      Section3bGuardDutyCreateHttpLogsSource:
        default: "Create Sumo Logic HTTP logs source"
      Section3cGuardDutyHttpLogsSourceCategoryName:
        default: "Sumo Logic HTTP logs source category name"

      # VPC flow logs apps parameters
      Section4aInstallVpcApps:
        default: "Install Sumo Logic VPC flow logs app"
      Section4bVpcCreateBucket:
        default: "Create S3 bucket"
      Section4cVpcLogsBucketName:
        default: "S3 bucket name"
      Section4dVpcCreateS3Source:
        default: "Create Sumo Logic S3 logs source"
      Section4eVpcBucketPathExpression:
        default: "Path expression for logs"
      Section4fVpcLogsSourceCategoryName:
        default: "Sumo Logic S3 logs source category name"

      # Threat Intel for AWS Parameters
      Section5aInstallThreatIntelApp:
        default: "Install Sumo Logic Threat Intel app"
      Section5bElasticLoadBalancerSourceCategory:
        default: "Sumo Logic ELB category name"

      # S3 audit app Parameters
      Section6aInstallS3AuditApp:
        default: "Install Sumo Logic S3 audit app"
      Section6bS3AuditCreateBucket:
        default: "Create S3 bucket"
      Section6cS3AuditLogsBucketName:
        default: "S3 bucket name"
      Section6dS3AuditCreateS3Source:
        default: "Create Sumo Logic S3 audit logs source"
      Section6eS3AuditBucketPathExpression:
        default: "Path expression for logs"
      Section6fS3AuditLogsSourceCategoryName:
        default: "Sumo Logic S3 audit logs source category name"

      # Security Hub app Parameters
      Section7aInstallSecurityHubAuditApp:
        default: "Install Sumo Logic AWS Security Hub app"
      Section7bEnableSecurityHub:
        default: "Enable Security Hub for the Region"
      Section7cSecurityHubCreateBucket:
        default: "Create S3 bucket"
      Section7dSecurityHubLogsBucketName:
        default: "S3 bucket name"
      Section7eSecurityHubCreateS3Source:
        default: "Create Sumo Logic S3 logs source"
      Section7fSecurityHubBucketPathExpression:
        default: "Path expression for  logs"
      Section7gSecurityHubLogsSourceCategoryName:
        default: "Sumo Logic S3 logs source category name"

      # WAF app Parameters
      Section8aInstallWafApp:
        default: "Install Sumo Logic AWS WAF app"
      Section8bCreateDeliveryStream:
        default: "Create a delivery stream for bucket"
      Section8cWafCreateBucket:
        default: "Create S3 bucket"
      Section8dWafLogsBucketName:
        default: "S3 bucket name"
      Section8eWafCreateS3Source:
        default: "Create Sumo Logic S3 logs source"
      Section8fWafBucketPathExpression:
        default: "Path expression for logs"
      Section8gWafLogsSourceCategoryName:
        default: "Sumo Logic S3 logs source category name"

      # Config app Parameters
      Section9aInstallConfigApp:
        default: "Install Sumo Logic AWS Config app"
      Section9bConfigEnableConfig:
        default: "Enable AWS Config for the Region"
      Section9cConfigCreateSNSTopic:
        default: "Create SNS Topic for logs delivery"
      Section9dConfigExistingTopicName:
        default: "Existing topic name where logs are delivered"
      Section9eConfigCreateHttpLogsSource:
        default: "Create Sumo Logic HTTP logs source"
      Section9fConfigHttpLogsSourceCategoryName:
        default: "Sumo Logic Amazon HTTP logs source category name"

      # Auto-enable parameters
      Section91aEnableAutoLogging:
        default: "Choose resource to auto-enable S3 logging"
      Section91bEnableLoggingForExistingResources:
        default: "Auto-enable logging for existing AWS resources"
      Section91cS3LoggingBucketPrefix:
        default: "Bucket prefix to store S3 audit logs"
      Section91dS3LoggingFilterExpression:
        default: "Regex expression to filter S3 buckets"
      Section91eVPCLoggingBucketPrefix:
        default: "Bucket prefix to store VPC flow logs"
      Section91fVPCLoggingFilterExpression:
        default: "Regex expression to filter VPC resources"

      QSS3BucketName:
        default: "Quick Start S3 bucket name"
      QSS3BucketRegion:
        default: "Quick Start S3 bucket Region"
      QSS3KeyPrefix:
        default: "Quick Start S3 key prefix"

Parameters:
  Section1aSumoLogicDeployment:
    Type: String
    AllowedValues:
      - au
      - ca
      - de
      - eu
      - jp
      - us2
      - us1
      - in
      - fed
    Description: "Enter the geographic location of the deployment: au, ca, de, eu, jp, us2, in, fed, or us1."
  Section1bSumoLogicAccessID:
    Type: String
    Description: "Enter the Sumo Logic console access ID, which you received when you created the access key."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic access ID cannot be empty."
  Section1cSumoLogicAccessKey:
    Type: String
    Description: "Enter your Sumo Logic access key. Retrieve this from your Sumo Logic account."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic access key cannot be empty."
    NoEcho: true
  Section1dSumoLogicOrganizationId:
    Description: "Enter your Sumo Logic organization ID, which you can find in the Sumo Logic console, under Account."
    Type: String
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic organization ID cannot be empty."
  Section1eSumoLogicResourceRemoveOnDeleteStack:
    AllowedValues:
      - "true"
      - "false"
    Default: "true"
    Description: "If this parameter is set to true, the collector, sources, and Sumo Logic apps are deleted.
                  If this parameter is set to false, then the collector, sources, and Sumo Logic apps are not deleted."
    Type: String

  # CloudTrail apps parameters
  Section2InstallCloudTrailApp:
    Type: String
    Description: "Yes: Install Sumo Logic AWS CloudTrail app.
                  No: Skip installation of app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2InstallPCICloudTrailApp:
    Type: String
    Description: "Yes: Install PCI compliance For AWS CloudTrail app.
                  No: Skip installation of app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2InstallCISFoundationApp:
    Type: String
    Description: "Yes: Install CIS AWS Foundations Benchmark app.
                  No: Skip installation of app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2InstallCloudTrailMonitoringAnalyticsApp:
    Type: String
    Description: "Yes: Install Amazon CloudTrail - Sumo Cloud Security Monitoring and Analytics App.
                  No: Skip installation of app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2InstallCloudTrailSecOpsApp:
    Type: String
    Description: "Yes: Install Sumo Global Intelligence for AWS CloudTrail SecOps App.
                  No: Skip installation of app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2CloudTrailCreateBucket:
    Type: String
    Description: "Yes: Create a new CloudTrail S3 bucket.
                  No: Use an existing CloudTrail S3 bucket that has CloudTrail logs."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2CloudTrailLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has CloudTrail logs."
    Default: ""
  Section2CloudTrailCreateLogSource:
    Type: String
    Description: "Yes: Create Sumo Logic CloudTrail log source with provided bucket name.
                  No: Skip creation of the Sumo Logic CloudTrail log source."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2CloudTrailBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for CloudTrail logs (e.g., AWSLogs/*/CloudTrail/*)."
    Default: "AWSLogs/*/CloudTrail/*"
  Section2CloudTrailLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting CloudTrail logs. This is used for Threat Intel for AWS app installation also."
    Default: "AWS/Cloudtrail/Logs"

  # GuardDuty apps parameters
  Section3aInstallGuardDutyApps:
    Type: String
    Description: "GuardDuty: Install Amazon GuardDuty app.
                  GlobalGuardDutyApp: Install Global Intelligence for Amazon GuardDuty app.
                  Both: Install both apps.
                  Skip: Skip installation of apps."
    Default: 'Both'
    AllowedValues:
      - 'GuardDuty'
      - 'GlobalGuardDuty'
      - 'Both'
      - 'Skip'
  Section3bGuardDutyCreateHttpLogsSource:
    Type: String
    Description: "Yes: Create Sumo Logic HTTP log source to collect GuardDuty logs.
                  No: Skip creation of the Sumo Logic HTTP log source."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section3cGuardDutyHttpLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from the GuardDuty logs. This is used for app installation."
    Default: ""

  # VPC flow logs apps parameters
  Section4aInstallVpcApps:
    Type: String
    Description: "VPC: Install Amazon VPC flow logs app in Sumo Logic.
                  PCI_VPC: Install PCI compliance VPC flow app.
                  CSMA_VPC: Install Amazon VPC Flow - Cloud Security Monitoring and Analytics app.
                  All: Install both apps.
                  Skip: Skip installation of apps."
    Default: 'Skip'
    AllowedValues:
      - 'VPC'
      - 'PCI_VPC'
      - 'CSMA_VPC'
      - 'All'
      - 'Skip'
  Section4bVpcCreateBucket:
    Type: String
    Description: "Yes: Create a new S3 bucket.
                  No: Use an existing S3 bucket that has VPC logs."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4cVpcLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has VPC flow logs."
    Default: ""
  Section4dVpcCreateS3Source:
    Type: String
    Description: "Yes: Create Sumo Logic S3 logs source with provided bucket name.
                  No: Skip creation of the Sumo Logic S3 log source."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4eVpcBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for VPC flow logs (e.g., VPC-FLOW-LOGS/*)."
    Default: "VPC-FLOW-LOGS/*"
  Section4fVpcLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting VPC flow logs. This is used for Threat Intel as well."
    Default: "AWS/Vpc/Flow/Logs"

  # Threat Intel for AWS Parameters
  Section5aInstallThreatIntelApp:
    Type: String
    Description: "Yes: Install Sumo Logic Threat Intel app.
                  No: Skip installation of the app."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section5bElasticLoadBalancerSourceCategory:
    Type: String
    Description: "Provide an existing source category from Sumo Logic that has ELB classic logs."
    Default: "*elb*"

  # S3 audit apps parameters
  Section6aInstallS3AuditApp:
    Type: String
    Description: "Yes: Install Sumo Logic S3 audit app.
                  No: Skip installation of the app."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section6bS3AuditCreateBucket:
    Type: String
    Description: "Yes: Create a new S3 bucket.
                  No: Use an existing S3 bucket that has S3 audit logs."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section6cS3AuditLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing S3 bucket that has audit logs."
    Default: ""
  Section6dS3AuditCreateS3Source:
    Type: String
    Description: "Yes: Create Sumo Logic S3 audit log source with provided bucket name.
                  No: Skip creation of the Sumo Logic S3 audit log source."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section6eS3AuditBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for S3 audit logs (e.g., S3-AUDIT-LOGS/*)."
    Default: "S3-AUDIT-LOGS/*"
  Section6fS3AuditLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting S3 audit logs. This is used for app installation."
    Default: ""

  # Security Hub app Parameters
  Section7aInstallSecurityHubAuditApp:
    Type: String
    Description: "Yes: Install Sumo Logic AWS Security Hub app.
                  No: Skip installation of app."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section7bEnableSecurityHub:
    Type: String
    Description: "Select Yes if Security Hub must be enabled for the Region."
    Default: "No"
    AllowedValues: ["Yes", "No"]
  Section7cSecurityHubCreateBucket:
    Type: String
    Description: "Yes: Create a new S3 bucket.
                  No: Use an existing S3 bucket that has Security Hub logs."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section7dSecurityHubLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing S3 bucket that has Security Hub logs."
    Default: ""
  Section7eSecurityHubCreateS3Source:
    Type: String
    Description: "Yes: Create Sumo Logic S3 logs source using your provided bucket name.
                  No: Skip creation of the Sumo Logic S3 logs source."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section7fSecurityHubBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for Security Hub logs (e.g., *securityhub*/*)."
    Default: "*securityhub*/*"
  Section7gSecurityHubLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting Security Hub logs. This is used for app installation."
    Default: ""

  # WAF app Parameters
  Section8aInstallWafApp:
    Type: String
    Description: "Yes: Install Sumo Logic AWS WAF app.
                  No: Skip installation of the app."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section8bCreateDeliveryStream:
    Type: String
    Description: "Yes: Create a Kinesis delivery stream using provided bucket name.
                  No: Skip creation of a Kinesis delivery stream."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section8cWafCreateBucket:
    Type: String
    Description: "Yes: Create a new S3 bucket.
                  No: Use an existing S3 bucket that has AWS WAF logs."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section8dWafLogsBucketName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing bucket name that has AWS WAF logs."
    Default: ""
  Section8eWafCreateS3Source:
    Type: String
    Description: "Yes: Create Sumo Logic S3 log source with provided bucket name.
                  No: Skip creation of the Sumo Logic S3 log source."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section8fWafBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for WAF logs (e.g., WAF_LOGS/*)."
    Default: "WAF_LOGS/*"
  Section8gWafLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting WAF logs. This is used for app installation."
    Default: ""

  # Config app Parameters
  Section9aInstallConfigApp:
    Type: String
    Description: "Yes: Install Sumo Logic AWS Config app.
                  No: Skip installation of app."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section9bConfigEnableConfig:
    Type: String
    Description: "Choose Yes to enable Config for the Region.
                  Choose No if Config is already enabled."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section9cConfigCreateSNSTopic:
    Type: String
    Description: "Choose Yes to create SNS Topic and attach the SNS topic to AWS Config setting to deliver the logs.
                  Choose No if Config logs are already delivered to an existing SNS topic."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section9dConfigExistingTopicName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing SNS topic from Config settings to stream configuration changes and notifications."
    Default: ""
  Section9eConfigCreateHttpLogsSource:
    Type: String
    Description: "Yes: Create Sumo Logic HTTP log source to collect Config logs.
                  No: Skip creation of the Sumo Logic HTTP log source."
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section9fConfigHttpLogsSourceCategoryName:
    Type: String
    Description: "Required when flag is set to No. Provide an existing source category name from Sumo Logic collecting Config logs. This is used for app installation."
    Default: ""

  # Auto-enable parameters
  Section91aEnableAutoLogging:
    Type: String
    Description: "S3: Enable S3 audit Logging for new S3 buckets.
                  VPC: Enable VPC flow logs for new VPC, subnets, and network interfaces.
                  S3_VPC: Enable logging for both."
    AllowedPattern: ".+"
    Default: 'Skip'
    AllowedValues:
      - 'S3'
      - 'VPC'
      - 'S3_VPC'
      - 'Skip'
  Section91bEnableLoggingForExistingResources:
    Type: String
    Description: "Yes: Enable Logging for existing resources.
                  No: Skip existing resources."
    Default: "No"
    AllowedValues:
      - 'Yes'
      - 'No'
  Section91cS3LoggingBucketPrefix:
    Type: String
    Description: "Provide an bucket prefix for S3 audit logs. It should have a slash (/) at the end."
    AllowedPattern: ".*\\/$"
    ConstraintDescription: "Bucket prefix should have slash (/) at the end."
    Default: "S3_AUDIT_LOGS/"
  Section91dS3LoggingFilterExpression:
    Type: String
    Default: ""
    Description: "Provide regular expression for matching S3 buckets (e.g., 'test|prod')."
  Section91eVPCLoggingBucketPrefix:
    Type: String
    Description: "Provide an bucket prefix VPC flow logs. It should have a slash (/) at the end."
    AllowedPattern: ".*\\/$"
    ConstraintDescription: "Bucket prefix should have a slash (/) at the end."
    Default: "VPC_LOGS/"
  Section91fVPCLoggingFilterExpression:
    Type: String
    Default: ""
    Description: "Provide regular expression for matching VPC resources (e.g., 'VpcId': 't1.micro.*?'|'NetworkInterfaceId': 'Test.*?']|'SubnetId': 'prod.*?'|test|prod')."

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: "aws-quickstart"
    Description: "S3 bucket name for the Quick Start assets. This string can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: "String"
  QSS3BucketRegion:
    Default: "us-east-1"
    Description: "The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value."
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "quickstart-sumo-logic-log-centralization/"
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

Conditions:
  # Conditions for CloudTrail apps
  install_cloudtrail_app: !Equals [ !Ref Section2InstallCloudTrailApp, 'Yes' ]
  install_pci_cloudtrail_app: !Equals [ !Ref Section2InstallPCICloudTrailApp, 'Yes' ]
  install_cis_foundations_app: !Equals [ !Ref Section2InstallCISFoundationApp, 'Yes' ]
  install_cloudtrail_monitoring_analytics_app: !Equals [!Ref Section2InstallCloudTrailMonitoringAnalyticsApp,'Yes']
  install_cloudtrail_secops_app: !Equals [!Ref Section2InstallCloudTrailSecOpsApp,'Yes']
  create_cloudtrail_bucket: !Equals [ !Ref Section2CloudTrailCreateBucket, 'Yes' ]
  create_cloudtrail_source: !Equals [ !Ref Section2CloudTrailCreateLogSource, 'Yes' ]

  # Conditions for GuardDuty apps
  install_guardduty_app: !Or
    - !Equals [ !Ref Section3aInstallGuardDutyApps, 'GuardDuty' ]
    - !Equals [ !Ref Section3aInstallGuardDutyApps, 'Both' ]
  install_global_guardduty_app: !Or
    - !Equals [ !Ref Section3aInstallGuardDutyApps, 'GlobalGuardDuty' ]
    - !Equals [ !Ref Section3aInstallGuardDutyApps, 'Both' ]
  create_guardduty_source: !Equals [ !Ref Section3bGuardDutyCreateHttpLogsSource, 'Yes' ]

  # Conditions for VPC flow logs apps
  install_vpc_app: !Or
    - !Equals [ !Ref Section4aInstallVpcApps, 'VPC' ]
    - !Equals [ !Ref Section4aInstallVpcApps, 'All' ]
  install_pci_vpc_app: !Or
    - !Equals [ !Ref Section4aInstallVpcApps, 'PCI_VPC' ]
    - !Equals [ !Ref Section4aInstallVpcApps, 'All' ]
  install_csma_vpc_app: !Or
    - !Equals [ !Ref Section4aInstallVpcApps, 'CSMA_VPC' ]
    - !Equals [ !Ref Section4aInstallVpcApps, 'All' ]  
  create_vpc_bucket: !Equals [ !Ref Section4bVpcCreateBucket, 'Yes' ]
  create_vpc_source: !Equals [ !Ref Section4dVpcCreateS3Source, 'Yes' ]

  # Conditions for Threat Intel app
  install_threat_intel_app: !Equals [ !Ref Section5aInstallThreatIntelApp, 'Yes' ]

  # Conditions for S3 audit app
  install_s3_audit_app: !Equals [ !Ref Section6aInstallS3AuditApp, 'Yes' ]
  create_s3_audit_bucket: !Equals [ !Ref Section6bS3AuditCreateBucket, 'Yes' ]
  create_s3_audit_source: !Equals [ !Ref Section6dS3AuditCreateS3Source, 'Yes' ]

  # Conditions for Security Hub app
  install_security_hub_app: !Equals [ !Ref Section7aInstallSecurityHubAuditApp, 'Yes' ]
  enable_security_hub: !Equals [ !Ref Section7bEnableSecurityHub, 'Yes' ]
  create_security_hub_bucket: !Equals [ !Ref Section7cSecurityHubCreateBucket, 'Yes' ]
  create_security_hub_source: !Equals [ !Ref Section7eSecurityHubCreateS3Source, 'Yes' ]

  # Conditions for WAF app
  install_waf_app: !Equals [ !Ref Section8aInstallWafApp, 'Yes' ]
  enable_waf: !Equals [ !Ref Section8bCreateDeliveryStream, 'Yes' ]
  create_waf_bucket: !Equals [ !Ref Section8cWafCreateBucket, 'Yes' ]
  create_waf_source: !Equals [ !Ref Section8eWafCreateS3Source, 'Yes' ]

  # Conditions for Config app
  install_config_app: !Equals [ !Ref Section9aInstallConfigApp, 'Yes' ]
  enable_config: !Equals [ !Ref Section9bConfigEnableConfig, 'Yes' ]
  create_sns_topic: !Equals [ !Ref Section9cConfigCreateSNSTopic, 'Yes' ]
  create_config_source: !Equals [ !Ref Section9eConfigCreateHttpLogsSource, 'Yes' ]

  # Conditions for auto-enable
  auto_enable_s3_audit: !Or
    - !Equals [ !Ref Section91aEnableAutoLogging, 'S3' ]
    - !Equals [ !Ref Section91aEnableAutoLogging, 'S3_VPC' ]
  auto_enable_vpc_logs: !Or
    - !Equals [ !Ref Section91aEnableAutoLogging, 'VPC' ]
    - !Equals [ !Ref Section91aEnableAutoLogging, 'S3_VPC' ]
  auto_exisitng_resources: !Equals [ !Ref Section91bEnableLoggingForExistingResources, 'Yes' ]

  # Conditions for common resources
  create_common_s3_bucket: !Or
    - !Condition create_cloudtrail_bucket
    - !Condition create_vpc_bucket
    - !Condition create_s3_audit_bucket
    - !Condition create_security_hub_bucket
    - !Condition create_waf_bucket
    - !Condition enable_config
  create_common_collector: !Or
    - !Condition create_cloudtrail_source
    - !Condition create_guardduty_source
    - !Condition create_vpc_source
    - !Condition create_s3_audit_source
    - !Condition create_security_hub_source
    - !Condition create_waf_source
    - !Condition create_config_source
  create_cloudtrail: !Condition create_cloudtrail_bucket

  # Conditions for calling child stack of each app if any resource create condition is true.
  call_cloudtrail_stack: !Or
    - !Condition install_cloudtrail_app
    - !Condition install_pci_cloudtrail_app
    - !Condition install_cis_foundations_app
    - !Condition install_cloudtrail_monitoring_analytics_app
    - !Condition install_cloudtrail_secops_app
    - !Condition create_cloudtrail_source
  call_guardduty_stack: !Or
    - !Condition install_guardduty_app
    - !Condition install_global_guardduty_app
    - !Condition create_guardduty_source
  call_vpc_stack: !Or
    - !Condition install_vpc_app
    - !Condition install_pci_vpc_app
    - !Condition install_csma_vpc_app
    - !Condition create_vpc_source
  call_threat_intel_stack: !Condition install_threat_intel_app
  call_s3_audit_stack: !Or
    - !Condition install_s3_audit_app
    - !Condition create_s3_audit_source
  call_security_hub_stack: !Or
    - !Condition install_security_hub_app
    - !Condition enable_security_hub
    - !Condition create_security_hub_source
  call_waf_stack: !Or
    - !Condition install_waf_app
    - !Condition enable_waf
    - !Condition create_waf_source
  call_config_stack: !Or
    - !Condition install_config_app
    - !Condition enable_config
    - !Condition create_sns_topic
    - !Condition create_config_source

  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']

Resources:

  WaitHandle:
    Type: "AWS::CloudFormation::WaitConditionHandle"

  CreateCommonResources:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/common/resources.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CreateCollector: !If [create_common_collector, 'Yes', 'No']
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateBucket: !If [create_common_s3_bucket, 'Yes', 'No']
        BucketName: !Join
          - ""
          - - "aws-quickstart-logs-"
            - !Select
              - 0
              - !Split
                - "-"
                - !Select
                  - 2
                  - !Split ["/", !Ref "AWS::StackId"]
        CreateTrail: !If [create_cloudtrail, 'Yes', 'No']
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  sumoCloudTrailAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_cloudtrail_stack
    DependsOn: CreateCommonResources
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/cloudtrail/cloudtrail.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallCloudTrailApp: !Ref Section2InstallCloudTrailApp
        InstallPCICloudTrailApp: !Ref Section2InstallPCICloudTrailApp
        InstallCISFoundationApp: !Ref Section2InstallCISFoundationApp
        InstallCloudTrailMonitoringAnalyticsApp: !Ref Section2InstallCloudTrailMonitoringAnalyticsApp
        InstallCloudTrailSecOpsApp: !Ref Section2InstallCloudTrailSecOpsApp 
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateCloudTrailBucket: "No"
        CloudTrailLogsBucketName: !If [create_cloudtrail_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section2CloudTrailLogsBucketName]
        CreateCloudTrailLogSource: !If [create_cloudtrail_source, "Yes", "No"]
        CloudTrailBucketPathExpression: !If [create_cloudtrail_bucket, !Sub "AWSLogs/${AWS::AccountId}/CloudTrail/*", !Ref Section2CloudTrailBucketPathExpression]
        CloudTrailLogsSourceName: !Sub "aws-quickstart-cloudtrail-${AWS::Region}"
        CloudTrailLogsSourceCategoryName: !If [create_cloudtrail_source, "aws/quickstart/cloudtrail/logs", !Ref Section2CloudTrailLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoGuardDutyStackWaitHandle:
    Condition: call_cloudtrail_stack
    DependsOn: sumoCloudTrailAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoGuardDutyStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_cloudtrail_stack, !Ref sumoGuardDutyStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoGuardDutyAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_guardduty_stack
    DependsOn: sumoGuardDutyStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/guardduty/guardduty.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallGuardDutyApp: !If [install_guardduty_app, "Yes", "No"]
        InstallGlobalGuardDutyApp: !If [install_global_guardduty_app, "Yes", "No"]
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateHttpLogsSource: !If [create_guardduty_source, "Yes", "No"]
        HttpLogsSourceName: !Sub "aws-quickstart-guardduty-${AWS::Region}"
        HttpLogsSourceCategoryName: !If [create_guardduty_source, "aws/quickstart/guardduty/logs", !Ref Section3cGuardDutyHttpLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoVpcStackWaitHandle:
    Condition: call_guardduty_stack
    DependsOn: sumoGuardDutyAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoVpcStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_guardduty_stack, !Ref sumoVpcStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoVpcAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_vpc_stack
    DependsOn: sumoVpcStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/vpc-flow-logs/vpcflowlogs.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallVpcApp: !If [install_vpc_app, "Yes", "No"]
        InstallPCIVpcApp: !If [install_pci_vpc_app, "Yes", "No"]
        InstallCSMAVpcApp: !If [install_csma_vpc_app, "Yes", "No"]
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName: !If [create_vpc_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section4cVpcLogsBucketName]
        CreateS3Source: !If [create_vpc_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [auto_enable_vpc_logs, !Sub "${Section91eVPCLoggingBucketPrefix}*", !Ref Section4eVpcBucketPathExpression]
        S3SourceName: !Sub "aws-quickstart-vpc-${AWS::Region}"
        S3SourceCategoryName: !If [create_vpc_source, "aws/quickstart/vpc/logs", !Ref Section4fVpcLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoThreatIntelStackWaitHandle:
    Condition: call_vpc_stack
    DependsOn: sumoVpcAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoThreatIntelStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_vpc_stack, !Ref sumoThreatIntelStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoThreatIntelAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_threat_intel_stack
    DependsOn: sumoThreatIntelStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/threat-intel-for-aws/threatintel.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CloudTrailSourceCategory: !If [create_cloudtrail_source, "aws/quickstart/cloudtrail/logs", !Ref Section2CloudTrailLogsSourceCategoryName]
        VPCFlowLogsSourceCategory: !If [create_vpc_source, "aws/quickstart/vpc/logs", !Ref Section4fVpcLogsSourceCategoryName]
        ElasticLoadBalancerSourceCategory: !Ref Section5bElasticLoadBalancerSourceCategory
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoS3AuditStackWaitHandle:
    Condition: call_threat_intel_stack
    DependsOn: sumoThreatIntelAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoS3AuditStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_threat_intel_stack, !Ref sumoS3AuditStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoS3AuditAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_s3_audit_stack
    DependsOn: sumoS3AuditStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/s3-audit/s3audit.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section6aInstallS3AuditApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName: !If [create_s3_audit_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section6cS3AuditLogsBucketName]
        CreateS3AuditSource: !If [create_s3_audit_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [auto_enable_s3_audit, !Sub "${Section91cS3LoggingBucketPrefix}*", !Ref Section6eS3AuditBucketPathExpression]
        S3AuditSourceName: !Sub "aws-quickstart-s3-audit-${AWS::Region}"
        S3AuditSourceCategoryName: !If [create_s3_audit_source, "aws/quickstart/s3/audit/logs", !Ref Section6fS3AuditLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoSecurityHubStackWaitHandle:
    Condition: call_s3_audit_stack
    DependsOn: sumoS3AuditAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoSecurityHubStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_s3_audit_stack, !Ref sumoSecurityHubStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoSecurityHubAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_security_hub_stack
    DependsOn: sumoSecurityHubStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/security-hub/securityhub.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section7aInstallSecurityHubAuditApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName: !If [create_security_hub_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section7dSecurityHubLogsBucketName]
        CreateS3Source: !If [create_security_hub_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [create_security_hub_bucket, "*securityhub*/*", !Ref Section7fSecurityHubBucketPathExpression]
        S3SourceName: !Sub "aws-quickstart-securityhub-${AWS::Region}"
        S3SourceCategoryName: !If [create_security_hub_source, "aws/quickstart/securityhub/logs", !Ref Section7gSecurityHubLogsSourceCategoryName]
        EnableSecurityHub: !If [enable_security_hub, "Yes", "No"]
        ConnectionName: !Sub "SecurityHubConnection${AWS::Region}-${AWS::AccountId}"
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoWafStackWaitHandle:
    Condition: call_security_hub_stack
    DependsOn: sumoSecurityHubAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoWafStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_security_hub_stack, !Ref sumoWafStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoWafAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_waf_stack
    DependsOn: sumoWafStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/WAF/waf.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section8aInstallWafApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        CreateS3Bucket: "No"
        LogsS3BucketName: !If [create_waf_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section8dWafLogsBucketName]
        CreateS3Source: !If [create_waf_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [enable_waf, "WAF_LOGS/*", !Ref Section8fWafBucketPathExpression]
        S3SourceName: !Sub "aws-quickstart-waf-${AWS::Region}"
        S3SourceCategoryName: !If [create_waf_source, "aws/quickstart/waf/logs", !Ref Section8gWafLogsSourceCategoryName]
        CreateDeliveryStream: !If [enable_waf, "Yes", "No"]
        DeliveryStreamName: !Sub "QuickStartDeliveryStream${AWS::Region}"
        CompressionFormat: "ZIP"
        S3BackupMode: "Disabled"
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoConfigStackWaitHandle:
    Condition: call_waf_stack
    DependsOn: sumoWafAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoConfigStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_waf_stack, !Ref sumoConfigStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoConfigAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_config_stack
    DependsOn: sumoConfigStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/config/config.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallApp: !Ref Section9aInstallConfigApp
        CollectorName: !Sub "aws-quickstart-collector-${AWS::AccountId}"
        EnableConfig: !If [enable_config, "Yes", "No"]
        BucketName: !GetAtt CreateCommonResources.Outputs.BucketName
        CreateSNSTopic: !If [create_sns_topic, "Yes", "No"]
        TopicName: !Ref Section9dConfigExistingTopicName
        CreateHttpLogsSource: !If [create_config_source, "Yes", "No"]
        HttpLogsSourceName: !Sub "aws-quickstart-config-${AWS::Region}"
        HttpLogsSourceCategoryName: !If [create_config_source, "aws/quickstart/config/logs", !Ref Section9fConfigHttpLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoAutoEnableS3AuditLogs:
    Type: AWS::CloudFormation::Stack
    Condition: auto_enable_s3_audit
    DependsOn: CreateCommonResources
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/AutoEnableS3Logging/auto_enable_s3_logging.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        EnableLogging: 'S3'
        ExistingResource: !If [auto_exisitng_resources, 'Yes', 'No']
        BucketName: !If [create_s3_audit_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section6cS3AuditLogsBucketName]
        BucketPrefix: !Ref Section91cS3LoggingBucketPrefix
        FilterExpression: !Ref Section91dS3LoggingFilterExpression
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  sumoAutoEnableVPCAuditLogs:
    Type: AWS::CloudFormation::Stack
    Condition: auto_enable_vpc_logs
    DependsOn: CreateCommonResources
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}apps/sumo-aws-apps/AutoEnableS3Logging/auto_enable_s3_logging.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        EnableLogging: 'VPC'
        ExistingResource: !If [auto_exisitng_resources, 'Yes', 'No']
        BucketName: !If [create_vpc_bucket, !GetAtt CreateCommonResources.Outputs.BucketName, !Ref Section4cVpcLogsBucketName]
        BucketPrefix: !Ref Section91eVPCLoggingBucketPrefix
        FilterExpression: !Ref Section91fVPCLoggingFilterExpression
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
